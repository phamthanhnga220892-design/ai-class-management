/**
 * Decode HTML entities to proper characters
 * This fixes issues where Vietnamese characters are stored as HTML entities
 */
export function decodeHtmlEntities(text: string): string {
    if (typeof window === 'undefined') {
        // Server-side: use a simple regex replacement for common entities
        const entities: Record<string, string> = {
            '&aacute;': 'á',
            '&agrave;': 'à',
            '&acirc;': 'â',
            '&atilde;': 'ã',
            '&auml;': 'ä',
            '&eacute;': 'é',
            '&egrave;': 'è',
            '&ecirc;': 'ê',
            '&iacute;': 'í',
            '&igrave;': 'ì',
            '&icirc;': 'î',
            '&oacute;': 'ó',
            '&ograve;': 'ò',
            '&ocirc;': 'ô',
            '&otilde;': 'õ',
            '&ouml;': 'ö',
            '&uacute;': 'ú',
            '&ugrave;': 'ù',
            '&ucirc;': 'û',
            '&uuml;': 'ü',
            '&yacute;': 'ý',
            '&#7843;': 'ả',
            '&#7841;': 'ạ',
            '&#7845;': 'ấ',
            '&#7847;': 'ầ',
            '&#7849;': 'ẩ',
            '&#7851;': 'ẫ',
            '&#7853;': 'ậ',
            '&#259;': 'ă',
            '&#7855;': 'ắ',
            '&#7857;': 'ằ',
            '&#7859;': 'ẳ',
            '&#7861;': 'ẵ',
            '&#7863;': 'ặ',
            '&#7865;': 'ẹ',
            '&#7867;': 'ế',
            '&#7869;': 'ề',
            '&#7871;': 'ể',
            '&#7873;': 'ễ',
            '&#7875;': 'ệ',
            '&#7877;': 'ỉ',
            '&#7879;': 'ị',
            '&#7881;': 'ọ',
            '&#7883;': 'ố',
            '&#7885;': 'ồ',
            '&#7887;': 'ổ',
            '&#7889;': 'ỗ',
            '&#7891;': 'ộ',
            '&#417;': 'ơ',
            '&#7899;': 'ớ',
            '&#7901;': 'ờ',
            '&#7903;': 'ở',
            '&#7905;': 'ỡ',
            '&#7907;': 'ợ',
            '&#7909;': 'ụ',
            '&#432;': 'ư',
            '&#7913;': 'ứ',
            '&#7915;': 'ừ',
            '&#7917;': 'ử',
            '&#7919;': 'ữ',
            '&#7921;': 'ự',
            '&#7923;': 'ỳ',
            '&#7925;': 'ỷ',
            '&#7927;': 'ỹ',
            '&#7929;': 'ỵ',
            // Uppercase
            '&#7842;': 'Ả',
            '&#7840;': 'Ạ',
            '&#7844;': 'Ấ',
            '&#7846;': 'Ầ',
            '&#7848;': 'Ẩ',
            '&#7850;': 'Ẫ',
            '&#7852;': 'Ậ',
            '&#258;': 'Ă',
            '&#7854;': 'Ắ',
            '&#7856;': 'Ằ',
            '&#7858;': 'Ẳ',
            '&#7860;': 'Ẵ',
            '&#7862;': 'Ặ',
            '&#7864;': 'Ẹ',
            '&#7866;': 'Ế',
            '&#7868;': 'Ề',
            '&#7870;': 'Ể',
            '&#7872;': 'Ễ',
            '&#7874;': 'Ệ',
            '&#7876;': 'Ỉ',
            '&#7878;': 'Ị',
            '&#7880;': 'Ọ',
            '&#7882;': 'Ố',
            '&#7884;': 'Ồ',
            '&#7886;': 'Ổ',
            '&#7888;': 'Ỗ',
            '&#7890;': 'Ộ',
            '&#416;': 'Ơ',
            '&#7898;': 'Ớ',
            '&#7900;': 'Ờ',
            '&#7902;': 'Ở',
            '&#7904;': 'Ỡ',
            '&#7906;': 'Ợ',
            '&#7908;': 'Ụ',
            '&#431;': 'Ư',
            '&#7912;': 'Ứ',
            '&#7914;': 'Ừ',
            '&#7916;': 'Ử',
            '&#7918;': 'Ữ',
            '&#7920;': 'Ự',
            '&#7922;': 'Ỳ',
            '&#7924;': 'Ỷ',
            '&#7926;': 'Ỹ',
            '&#7928;': 'Ỵ',
            '&Aacute;': 'Á',
            '&Agrave;': 'À',
            '&Acirc;': 'Â',
            '&Atilde;': 'Ã',
            '&Eacute;': 'É',
            '&Egrave;': 'È',
            '&Ecirc;': 'Ê',
            '&Iacute;': 'Í',
            '&Igrave;': 'Ì',
            '&Icirc;': 'Î',
            '&Oacute;': 'Ó',
            '&Ograve;': 'Ò',
            '&Ocirc;': 'Ô',
            '&Otilde;': 'Õ',
            '&Uacute;': 'Ú',
            '&Ugrave;': 'Ù',
            '&Ucirc;': 'Û',
            '&Yacute;': 'Ý',
            '&amp;': '&',
            '&lt;': '<',
            '&gt;': '>',
            '&quot;': '"',
            '&#39;': "'",
        };

        let decoded = text;
        for (const [entity, char] of Object.entries(entities)) {
            decoded = decoded.replace(new RegExp(entity, 'g'), char);
        }
        return decoded;
    }

    // Client-side: use browser's DOMParser
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
}
